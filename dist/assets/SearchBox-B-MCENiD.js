import{e as P,i as me,B as j,f as ge,l as ye,d as we,c as g,o as y,a as w,k as xe,b as T,q as ve,u as o,H as Se,t as E,F as Y,m as Z,x as ee}from"./vendor-BYORPvVJ.js";import{l as te}from"./useArticleIndex-BnDR0Dmu.js";let M=null;const re=new Map;let H=null,B=null,F=null;const be=async()=>H||B||(B=fetch("/search-index.json").then(async l=>{if(!l.ok)throw new Error("Failed to load search index");return await l.json()}).then(l=>(H=l,l)).finally(()=>{B=null}),B),ke=async l=>{const d=re.get(l);if(d)return d;const s=await fetch(`/search-index-${l}.json`).then(async f=>{if(!f.ok)throw new Error("Failed to load search index");return await f.json()});return re.set(l,s),s},ae=async()=>M||F||(F=(async()=>{const l=await be();return M=(await Promise.all(l.categories.map(s=>ke(s)))).flat(),M})().finally(()=>{F=null}),F),Ie=l=>{const d=P(""),s=P([]),f=P(!1),x=P(null),c=P(null);let N=!1,I=0,C=null,b=null,k=!1,L=!1;const R=()=>{N||(N=!0,te(),ae())},U=()=>{s.value=[],f.value=!1,c.value=null},A=(e,t)=>{const r=t.trim();if(!r)return[{text:e,mark:!1}];const a=e.toLowerCase(),n=r.toLowerCase(),u=[];let p=0,S=a.indexOf(n,p);for(;S!==-1;)S>p&&u.push({text:e.slice(p,S),mark:!1}),u.push({text:e.slice(S,S+r.length),mark:!0}),p=S+r.length,S=a.indexOf(n,p);return p<e.length&&u.push({text:e.slice(p),mark:!1}),u},$=e=>{if(!e||k)return;const t=new URLSearchParams;t.set("search",e);const r=`?${t.toString()}`;L?window.history.replaceState({},"",r):(L=!0,window.history.pushState({},"",r))},i=async(e,t)=>{const r=await te(),a=[];for(const n of r)n.articleName.toLowerCase().includes(e)&&a.push({articlePath:n.articlePath,articleName:n.articleName,category:n.category,snippet:`ファイル名: ${n.articleName}`,lineNumber:0,preIndex:0,searchQuery:t,isFileNameMatch:!0});return a},h=async(e,t,r)=>{const a=[...r],n=await ae();for(const u of n)u.preBlocks.forEach((p,S)=>{const K=p.split(`
`);K.forEach((de,q)=>{if(de.toLowerCase().includes(e)){const he=Math.max(0,q-5),fe=Math.min(K.length,q+6),X=K.slice(he,fe).filter(Q=>Q.trim()!=="");if(X.length===0)return;const pe=X.map(Q=>Q.trim()).join(`
`).trim();a.push({articlePath:u.articlePath,articleName:u.articleName,category:u.category,snippet:pe,lineNumber:q+1,preIndex:S,searchQuery:t,isFileNameMatch:!1})}})});return a},m=(e,t,r)=>e!==I?!1:(s.value=r,f.value=!0,c.value=null,$(t),!0),v=(e,t)=>e!==I?!1:(s.value=t,f.value=!1,c.value=null,!0),_=()=>{if(C!==null&&clearTimeout(C),!d.value.trim()){U();return}f.value=!0,c.value=null,C=window.setTimeout(()=>{se()},300)},se=async()=>{const e=d.value.trim();if(!e){U();return}const t=++I;s.value=[];try{const r=e.toLowerCase(),a=await i(r,e);m(t,e,a);const n=await h(r,e,a);v(t,n)}catch(r){console.error("Search error:",r),t===I&&(f.value=!1)}},z=(e,t)=>{if(t!==void 0&&d.value){const n=new URLSearchParams;n.set("search",d.value),n.set("resultIndex",t.toString());const u=`?${n.toString()}`;window.history.replaceState({},"",u)}L=!1;const r=new URLSearchParams;r.set("category",e.category),r.set("article",e.articleName),e.isFileNameMatch||(r.set("preIndex",e.preIndex.toString()),r.set("query",e.searchQuery));const a=`?${r.toString()}`;window.history.pushState({},"",a),l("skipNextUrlUpdate"),l("update:selectedCategory",e.category),l("update:selectedArticle",e.articleName),e.isFileNameMatch||l("scrollToPreIndex",e.preIndex,e.searchQuery),d.value="",s.value=[],c.value=null},ne=(e,t)=>{const r=t.getBoundingClientRect(),a=e.getBoundingClientRect(),n=a.top<r.top,u=a.bottom>r.bottom;n?t.scrollTop-=r.top-a.top:u&&(t.scrollTop+=a.bottom-r.bottom)},D=async e=>{if(e<0||e>=s.value.length)return;c.value=e,await j();const t=document.querySelector(`[data-result-index="${e}"]`);if(!t)return;const r=t.closest(".overflow-y-auto");r&&ne(t,r),t.focus()},V=e=>{const t=s.value[e];t&&z(t,e)},O=()=>{c.value=null,x.value?.focus()},oe=e=>{e.key==="ArrowDown"&&s.value.length>0?(e.preventDefault(),D(0)):e.key==="Enter"&&s.value.length>0&&(e.preventDefault(),V(0))},le=(e,t)=>{if(e.key==="ArrowDown"){e.preventDefault(),D(Math.min(t+1,s.value.length-1));return}if(e.key==="ArrowUp"){e.preventDefault();const r=t-1;r<0?O():D(r);return}if(e.key==="Enter"){e.preventDefault(),V(t);return}e.key==="Escape"&&(e.preventDefault(),O())},ce=e=>{l("skipNextUrlUpdate"),l("update:selectedCategory",null),l("update:selectedArticle",null),d.value=e,window.scrollTo(0,0),_()},ie=e=>{if(!e)return;const t=parseInt(e,10);isNaN(t)||(b=t)},ue=()=>{sessionStorage.getItem("reloadedFromSearch")&&(sessionStorage.removeItem("reloadedFromSearch"),d.value="",s.value=[])},G=()=>{const e=new URLSearchParams(window.location.search),t=e.get("search"),r=e.get("category"),a=e.get("article"),n=e.get("resultIndex");k=!0,t?(ie(n),ce(t)):!r&&!a&&ue(),setTimeout(()=>{k=!1},100)},J=()=>{x.value?.focus()},W=e=>{if(e.defaultPrevented||e.key!=="f"&&e.key!=="F"||e.metaKey||e.ctrlKey||e.altKey)return;const t=e.target;if(t){const r=t.tagName?.toLowerCase();if(r==="input"||r==="textarea"||t.isContentEditable)return}e.preventDefault(),J()};return me(()=>{new URLSearchParams(window.location.search).get("search")&&(window.history.replaceState({},"","/"),d.value="",s.value=[],j(()=>{window.scrollTo(0,0)})),l("ready"),window.addEventListener("popstate",G),window.addEventListener("keydown",W),"requestIdleCallback"in window?window.requestIdleCallback?.(()=>{R()}):setTimeout(()=>{R()},500)}),ge(()=>{window.removeEventListener("popstate",G),window.removeEventListener("keydown",W)}),ye(s,async()=>{if(s.value.length>0&&window.scrollTo(0,0),b!==null&&s.value.length>0){const e=b;b=null,await j(),setTimeout(()=>{const t=document.querySelectorAll("[data-result-index]"),r=Array.from(t).find(a=>a.getAttribute("data-result-index")===String(e));if(r){const a=r.closest(".overflow-y-auto");if(a){const n=a.getBoundingClientRect(),u=r.getBoundingClientRect(),p=u.top-n.top+a.scrollTop-a.clientHeight/2+u.height/2;a.scrollTop=p}}k=!1},100)}}),{searchQuery:d,searchResults:s,isSearching:f,inputRef:x,activeResultIndex:c,getHighlightedSegments:A,performSearch:_,prefetchSearchIndex:R,selectSearchResult:z,handleInputKeydown:oe,handleResultKeydown:le,focusInput:J}},Re={class:"relative mb-16"},Ne={key:0,class:"absolute top-8 right-16 text-gray-400"},Ce={key:1,class:"absolute z-10 mt-4 max-h-[calc(100vh-160px)] w-full overflow-y-auto rounded-md border border-gray-300 bg-white shadow-lg"},Le={class:"sticky top-0 z-10 border-b border-gray-300 bg-gray-100 px-16 py-8 text-sm text-gray-600"},Pe=["data-result-index","onKeydown","onClick"],Te={class:"flex items-center gap-8"},Be={class:"text-12 rounded bg-blue-500 px-8 py-2 text-white"},Fe={key:0,class:"text-12 rounded bg-green-500 px-8 py-2 text-white"},Ue={class:"font-bold"},_e={key:0,class:"text-12 mt-8 overflow-x-auto rounded bg-[#112233] p-8 break-all whitespace-pre-wrap text-white"},Ee=["textContent"],Me={key:2,class:"absolute z-10 mt-4 w-full rounded-md border border-gray-300 bg-white p-16 shadow-lg"},qe=we({__name:"SearchBox",emits:["update:selectedCategory","update:selectedArticle","scrollToPreIndex","skipNextUrlUpdate","ready"],setup(l,{expose:d,emit:s}){const f=s,{searchQuery:x,searchResults:c,isSearching:N,activeResultIndex:I,getHighlightedSegments:C,performSearch:b,prefetchSearchIndex:k,selectSearchResult:L,handleInputKeydown:R,handleResultKeydown:U,focusInput:A}=Ie(f);return d({focusInput:A}),($,i)=>(y(),g("div",Re,[i[5]||(i[5]=w("svg",{class:"absolute top-12 left-12 h-20 w-20 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true"},[w("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)),i[6]||(i[6]=w("label",{for:"search-input",class:"sr-only"},"Search",-1)),xe(w("input",{id:"search-input",ref:"inputRef","onUpdate:modelValue":i[0]||(i[0]=h=>Se(x)?x.value=h:null),onInput:i[1]||(i[1]=(...h)=>o(b)&&o(b)(...h)),onFocus:i[2]||(i[2]=(...h)=>o(k)&&o(k)(...h)),onKeydown:i[3]||(i[3]=(...h)=>o(R)&&o(R)(...h)),type:"text",placeholder:"",autocomplete:"off",class:"w-full rounded-md border border-gray-300 py-8 pr-16 pl-40 focus:border-blue-500 focus:outline-none"},null,544),[[ve,o(x)]]),o(N)?(y(),g("span",Ne," Searching... ")):T("",!0),o(c).length>0?(y(),g("div",Ce,[w("div",Le,E(o(c).length)+" results found ",1),(y(!0),g(Y,null,Z(o(c),(h,m)=>(y(),g("div",{key:m,"data-result-index":m,role:"button",tabindex:"0",onKeydown:v=>o(U)(v,m),onClick:()=>{const v=o(c)[m];v&&o(L)(v,m)},class:ee(["cursor-pointer border-b border-gray-200 p-16 hover:bg-gray-50 focus:outline-none",o(I)===m?"bg-gray-100":""])},[w("div",Te,[w("span",Be,E(h.category),1),o(c)[m]?.isFileNameMatch?(y(),g("span",Fe," page ")):T("",!0),w("span",Ue,E(h.articleName),1)]),o(c)[m]?.isFileNameMatch?T("",!0):(y(),g("pre",_e,[w("code",null,[(y(!0),g(Y,null,Z(o(C)(h.snippet,o(x)),(v,_)=>(y(),g("span",{key:_,class:ee(v.mark?"rounded-sm bg-yellow-200 px-2 font-bold text-black":""),textContent:E(v.text)},null,10,Ee))),128))])]))],42,Pe))),128))])):T("",!0),o(x)&&!o(N)&&o(c).length===0?(y(),g("div",Me,[...i[4]||(i[4]=[w("p",{class:"text-gray-500"},"No results found",-1)])])):T("",!0)]))}});export{qe as default};
